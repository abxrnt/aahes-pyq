<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PROYAX PYQ Portal</title>

  <!-- Tailwind CDN (optional, we still include custom CSS below) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Quicksand font + Merriweather for headings -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&family=Merriweather:ital@0;1&display=swap" rel="stylesheet">

  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root{
      --sidebar-w:260px;
      --accent-a: #06b6d4;
      --accent-b: #06a3ff;
      --card-radius: 18px;
      --qno-w: 60px;
    }
    html,body{height:100%;margin:0;font-family:'Quicksand',sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background:#ffffff;}

    /* ===========================
       SPLIT LOGIN / REGISTER CARD
       =========================== */
    .auth-overlay {
      position: fixed; inset: 0; z-index: 60;
      background: rgba(8,10,25,0.45);
      backdrop-filter: blur(6px) saturate(1.02);
      display: flex; align-items: center; justify-content: center;
    }
    .auth-card {
      width: min(1140px, 96vw);
      border-radius: var(--card-radius);
      display: flex;
      overflow: hidden;
      box-shadow: 0 30px 70px rgba(2,6,23,0.5);
      background: linear-gradient(180deg, rgba(255,255,255,0.97), rgba(250,250,252,0.98));
      border: 1px solid rgba(255,255,255,0.4);
      min-height: 64vh;
      max-height: 92vh;
    }

    /* left = form panel */
    .auth-left{
      flex: 1 1 46%;
      padding: 44px 42px;
      display:flex; flex-direction:column; justify-content:center;
      background: linear-gradient(135deg, rgba(6,24,31,0.85), rgba(14,60,58,0.85));
      color: #f8fafc;
      gap:14px;
      box-sizing:border-box;
      position:relative;
    }
    .auth-left h1{font-family:'Merriweather',serif;font-size:38px;margin:0 0 6px;color:#ecfeff;letter-spacing:-0.6px}
    .auth-sub{color: rgba(255,255,255,0.82); margin-bottom:12px}
    .auth-form { width:100%; max-width:520px; display:flex; flex-direction:column; gap:14px; }
    .input-lg { padding:16px 18px; border-radius:14px; border:none; font-size:16px; background: rgba(255,255,255,0.06); color: #fff; outline:none; box-sizing:border-box; }
    .input-lg::placeholder{ color: rgba(255,255,255,0.65); }
    .btn-primary-lg { margin-top:8px; background: linear-gradient(90deg,var(--accent-a),var(--accent-b)); color:#fff; padding:14px 18px; border-radius:14px; border:none; font-weight:700; cursor:pointer; box-shadow: 0 12px 30px rgba(6,167,255,0.14); }
    .small-link { color: #fde047; text-decoration:underline; cursor:pointer; font-weight:600; }
    .auth-left .cta-row { display:flex; gap:12px; margin-top:8px; align-items:center; }
    .ghost-btn { background: rgba(255,255,255,0.06); color:#fff; padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); cursor:pointer; font-weight:600; }

    /* right = visual panel */
    .auth-right {
      flex: 1 1 54%;
      background-image: url('https://images.unsplash.com/photo-1688494930045-328d0f95efe9?auto=format&fit=crop&w=2000&q=60');
      background-size: cover;
      background-position: center;
      display:flex; align-items:center; justify-content:center; padding:36px; position:relative;
    }
    .auth-right::before {
      content:''; position:absolute; inset:0; background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); mix-blend-mode: overlay;
    }
    .right-inner { position:relative; z-index:1; color:#fff; text-align:center; max-width:520px; }
    .brand-logo { width:96px; height:96px; margin: 0 auto 12px; display:block; border-radius:14px; box-shadow:0 12px 30px rgba(2,6,23,0.35); background:#fff url('favicon.png') center/60% no-repeat; background-size:contain; }
    .right-title { font-family:'Merriweather',serif; font-size:36px; margin:8px 0 6px; color:#fff; text-shadow:0 6px 24px rgba(2,6,23,0.4); }
    .right-desc { color: rgba(255,255,255,0.9); line-height:1.6; font-size:15px; margin-top:8px; }

    /* small screens */
    @media (max-width:960px){
      .auth-card{flex-direction:column; min-height: auto; max-height: 96vh;}
      .auth-left, .auth-right{flex:1 1 100%; padding:24px;}
      .auth-left h1{font-size:28px}
      .right-title{font-size:24px}
    }

    /* ===========================
       REMAINING APP STYLES (kept)
       =========================== */
    #mainApp{display:none;height:100vh;width:100%;flex-direction:row;overflow:hidden;}
    #sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);background:#1f2937;padding:1.5rem 1rem;color:white;height:100vh;display:flex;flex-direction:column;justify-content:space-between;gap:.5rem;box-sizing:border-box;}
    .logo-block img{width:64px;margin:0 auto .35rem;}
    #sidebar p#welcomeMsg{font-size:.95rem;margin-top:.3rem;color:#facc15;text-align:center;}
    .profile-btn{background:#070e6b;color:#e6eef5;padding:.45rem .85rem;border-radius:.7rem;}
    .logout-btn{background:#f43f5e;padding:.45rem .85rem;border-radius:.7rem;}
    .tab-active{background: linear-gradient(135deg,#2563eb,#1e40af); color:#f8fafc; font-weight:600;}

    .main-content{flex:1;overflow-y:auto;padding:0;background:#ffffff;min-height:100vh;box-sizing:border-box;}
    .table-wrap{overflow-x:auto;margin:0;width:100%;}
    table{width:100% !important;border-collapse:collapse;font-size:.95rem;table-layout:fixed;}
    thead th{background:#0c2b4e;color:white;padding:.6rem .75rem;text-align:left;vertical-align:middle;}
    table thead th:nth-child(1), table tbody td:nth-child(1){width:var(--qno-w);min-width:var(--qno-w);max-width:var(--qno-w);text-align:center;padding:.5rem .5rem;box-sizing:border-box;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    table thead th:nth-child(2), table tbody td:nth-child(2){width:auto;text-align:left;padding:.9rem .9rem;}
    table thead th:nth-child(3), table tbody td:nth-child(3){text-align:center;vertical-align:middle;padding:.9rem .75rem;width:36%;}
    tbody td{padding:.6rem .75rem;vertical-align:top;}
    tbody tr:not(:last-child){border-bottom:2px solid #e5e7eb;}
    .pyq-img{max-width:520px;width:100%;height:auto;border-radius:.6rem;cursor:pointer;display:block;margin:0.35rem auto;object-fit:contain;}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:70;}
    .modal.show{display:flex;}
    .modal-content{background:white;padding:2rem;border-radius:1.2rem;max-width:900px;width:92%;max-height:90vh;overflow:auto;position:relative;box-shadow:0 15px 30px rgba(0,0,0,0.35);}
    .close-btn{position:absolute;top:1rem;right:1rem;font-size:1.3rem;font-weight:bold;cursor:pointer;transition:all .15s;}
    @media (max-width:900px){#sidebar{display:none;} .pyq-img{max-width:420px}}
    @media (max-width:700px){table thead th:nth-child(3),table tbody td:nth-child(3){display:none;} table thead th:nth-child(2),table tbody td:nth-child(2){width:80%;} table thead th:nth-child(1),table tbody td:nth-child(1){width:20%;min-width:48px;max-width:80px;} .pyq-img{max-width:320px}}
  </style>
</head>
<body>

  <!-- ===== Split Login/Register Card (shows on load) ===== -->
  <div id="authOverlay" class="auth-overlay" aria-hidden="false">
    <div class="auth-card" role="dialog" aria-modal="true" aria-labelledby="loginHeading">
      <!-- LEFT: Form -->
      <div class="auth-left">
        <h1 id="loginHeading">Welcome Back</h1>
        <div class="auth-sub" id="authSub">Access previous year questions as images easily. Prepare smarter and faster for your exams.</div>

        <div class="auth-form" id="loginPanel">
          <input id="loginEmail" class="input-lg" placeholder="Email" autocomplete="username" />
          <input id="loginPass" type="password" class="input-lg" placeholder="Password" autocomplete="current-password" />
          <button id="loginBtn" class="btn-primary-lg">Login</button>

          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
            <div>Forgot your password? <span id="forgotLink" class="small-link">Click here</span></div>
            <div style="display:flex; gap:8px;">
              <button id="showRegisterBtn" class="ghost-btn">Register</button>
            </div>
          </div>
        </div>

        <!-- Register panel (hidden by default) -->
        <div class="auth-form" id="registerPanel" style="display:none;">
          <input id="regUsername" class="input-lg" placeholder="Username" />
          <input id="regName" class="input-lg" placeholder="Full name" />
          <input id="regEmail" class="input-lg" placeholder="Email" />
          <input id="regPass" class="input-lg" type="password" placeholder="Password (6+ chars)" />
          <div style="display:flex; gap:12px;">
            <button id="registerBtn" class="btn-primary-lg" style="flex:1">Register</button>
            <button id="cancelRegister" class="ghost-btn">Cancel</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Visual -->
      <div class="auth-right">
        <div class="right-inner">
          <div class="brand-logo" aria-hidden="true"></div>
          <div class="right-title">PROYAX PYQ Portal</div>
          <div class="right-desc">Access previous year questions as images easily. Prepare smarter and faster for your exams.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Main App (hidden until login) ===== -->
  <section id="mainApp" class="flex h-screen" aria-hidden="true">
    <!-- Sidebar -->
    <div id="sidebar">
      <div>
        <div class="logo-block">
          <img src="favicon.png" alt="Logo">
          <div class="font-semibold text-lg">PROYAX PYQ</div>
          <p id="welcomeMsg" class="mt-2 text-sm text-yellow-400 font-medium">Welcome, User! ðŸ˜Š</p>
          <p>Best of Luck!</p>
        </div>

        <div id="sidebarTop" class="mb-4 text-center">
          <div class="flex justify-center gap-2">
            <button id="profileBtn" class="profile-btn"><i data-lucide="user"></i> Profile</button>
            <button id="logoutBtn" class="logout-btn"><i data-lucide="log-out"></i> Logout</button>
          </div>
        </div>

        <div class="mb-3">
          <h3>Subjects</h3>
          <div id="subjectButtons" class="flex flex-col gap-2"></div>
        </div>

        <div class="mb-3">
          <h3>Years</h3>
          <div id="yearButtons" class="grid grid-cols-2 gap-2"></div>
        </div>
      </div>

      <div class="text-center">
        <small class="text-gray-400">AAHES â€¢ PYQ Portal</small>
      </div>
    </div>

    <!-- Main content -->
    <div class="main-content">
      <div class="table-wrap mb-4 -mt-2">
        <table>
          <thead>
            <tr>
              <th>QNo</th>
              <th>Question</th>
              <th>Solution</th>
            </tr>
          </thead>
          <tbody id="pyqTableBody">
            <tr><td colspan="3" class="text-center p-4">Select a subject and year</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Image modal -->
  <div id="imageModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span id="imageModalClose" class="close-btn">&times;</span>
      <img id="pyqImage" src="" alt="Preview" style="max-width:100%;height:auto;border-radius:.6rem;">
    </div>
  </div>

  <!-- Profile modal -->
  <div id="profileModal" class="modal" aria-hidden="true">
    <div class="modal-content" id="profileCard">
      <button id="closeProfileModal" class="close-btn">&times;</button>
      <h2 style="text-align:center;margin:0 0 12px;">ðŸ‘¤ Profile Settings</h2>
      <form id="profileForm" style="display:flex;flex-direction:column;gap:10px;">
        <input id="profileName" class="input-lg" placeholder="Full name" />
        <input id="profileClass" class="input-lg" placeholder="Class" />
        <input id="newPassword" type="password" class="input-lg" placeholder="New password" />
        <button type="submit" class="btn-primary-lg">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Sidebar backdrop for mobile -->
  <div id="sidebarBackdrop"></div>

  <!-- Firebase + App JS -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBOVl1hdmprJXpgdN_sNTO3FsNePD_zNZY",
      authDomain: "aahes-cee-cutoffs.firebaseapp.com",
      databaseURL: "https://aahes-cee-cutoffs-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "aahes-cee-cutoffs",
      storageBucket: "aahes-cee-cutoffs.firebasedatabase.app",
      messagingSenderId: "706066626405",
      appId: "1:706066626405:web:0d254ab82beb288108938c"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ---------- DOM refs ----------
    const authOverlay = document.getElementById('authOverlay');
    const loginPanel = document.getElementById('loginPanel');
    const registerPanel = document.getElementById('registerPanel');
    const showRegisterBtn = document.getElementById('showRegisterBtn');
    const cancelRegister = document.getElementById('cancelRegister');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');

    const loginEmail = document.getElementById('loginEmail');
    const loginPass = document.getElementById('loginPass');
    const regUsername = document.getElementById('regUsername');
    const regName = document.getElementById('regName');
    const regEmail = document.getElementById('regEmail');
    const regPass = document.getElementById('regPass');

    const mainApp = document.getElementById('mainApp');
    const pyqTableBody = document.getElementById('pyqTableBody');
    const subjectButtons = document.getElementById('subjectButtons');
    const yearButtons = document.getElementById('yearButtons');

    const imageModal = document.getElementById('imageModal');
    const imageModalClose = document.getElementById('imageModalClose');
    const pyqImage = document.getElementById('pyqImage');

    const profileModal = document.getElementById('profileModal');
    const profileBtn = document.getElementById('profileBtn');
    const closeProfileModal = document.getElementById('closeProfileModal');
    const profileName = document.getElementById('profileName');
    const profileClass = document.getElementById('profileClass');
    const newPassword = document.getElementById('newPassword');
    const profileForm = document.getElementById('profileForm');

    const sidebar = document.getElementById('sidebar');
    const sidebarBackdrop = document.getElementById('sidebarBackdrop');

    // state
    let currentUser = null;
    let currentSubject = "physics";
    let currentYear = 2025;
    const subjects = ["physics","chemistry","maths"];
    const years = [2025,2024,2023,2022];

    // Show login overlay on load
    function showAuth(){ authOverlay.style.display = 'flex'; authOverlay.setAttribute('aria-hidden','false'); mainApp.style.display = 'none'; }
    function hideAuth(){ authOverlay.style.display = 'none'; authOverlay.setAttribute('aria-hidden','true'); mainApp.style.display = 'flex'; }
    showAuth();

    // toggle forms
    showRegisterBtn.addEventListener('click', ()=>{ loginPanel.style.display='none'; registerPanel.style.display='flex'; });
    cancelRegister.addEventListener('click', ()=>{ registerPanel.style.display='none'; loginPanel.style.display='flex'; });

    // ------ LOGIN (simple Firestore check like before) ------
    loginBtn.addEventListener('click', async () => {
      const email = loginEmail.value.trim();
      const pass = loginPass.value.trim();
      if(!email||!pass){ alert('Enter email & password'); return; }

      try{
        const q = query(collection(db,'users'), where('email','==',email));
        const snap = await getDocs(q);
        if(snap.empty){ alert('User not found'); return; }
        let found=false;
        snap.forEach(docSnap => {
          const data = docSnap.data();
          if(data.password === pass){
            found=true;
            currentUser = { id: docSnap.id, ...data };
          }
        });
        if(!found){ alert('Incorrect password'); return; }
        // success
        hideAuth();
        document.getElementById('welcomeMsg').innerText = `Welcome, ${currentUser.name || currentUser.username || 'User'}! ðŸ˜Š`;
        generateButtons();
        loadPYQs().catch(e=>console.error(e));
        if(window.lucide) window.lucide.createIcons();
      }catch(err){ console.error(err); alert('Login failed'); }
    });

    // ------ REGISTER (Firestore + optional Firebase Auth) ------
    registerBtn.addEventListener('click', async () => {
      const username = regUsername.value.trim();
      const name = regName.value.trim();
      const email = regEmail.value.trim();
      const pass = regPass.value.trim();
      if(!username||!email||!pass){ alert('Enter username, email and password'); return; }
      if(pass.length < 6){ alert('Password must be 6+ characters'); return; }

      try{
        // add to Firestore
        await addDoc(collection(db,'users'), { username, name, email, password: pass, createdAt: new Date(), class: '' });
        // optionally create Firebase Auth user (non-blocking)
        try{ await createUserWithEmailAndPassword(auth, email, pass); }catch(e){ console.warn('Auth create skipped:', e); }
        alert('Registered â€” you can now login.');
        registerPanel.style.display='none'; loginPanel.style.display='flex';
      }catch(err){ console.error('Register failed', err); alert('Registration failed'); }
    });

    // ---------- Table buttons ----------
    function generateButtons(){
      subjectButtons.innerHTML = '';
      subjects.forEach(s => {
        const btn = document.createElement('button');
        btn.innerText = s.charAt(0).toUpperCase()+s.slice(1);
        if(s===currentSubject) btn.classList.add('tab-active');
        btn.addEventListener('click', ()=>{ currentSubject=s; subjectButtons.querySelectorAll('button').forEach(b=>b.classList.remove('tab-active')); btn.classList.add('tab-active'); loadPYQs(); });
        subjectButtons.appendChild(btn);
      });
      yearButtons.innerHTML='';
      years.forEach(y=>{
        const btn = document.createElement('button');
        btn.innerText = y;
        if(y===currentYear) btn.classList.add('tab-active');
        btn.addEventListener('click', ()=>{ currentYear=y; yearButtons.querySelectorAll('button').forEach(b=>b.classList.remove('tab-active')); btn.classList.add('tab-active'); loadPYQs(); });
        yearButtons.appendChild(btn);
      });
    }

    // ---------- Load PYQs ----------
    async function loadPYQs(){
      try{
        pyqTableBody.innerHTML = "<tr><td colspan='3' class='text-center p-4'>Loading...</td></tr>";
        const q = query(collection(db,'pyqs'), where('subject','==',currentSubject), where('year','==',currentYear));
        const snapshot = await getDocs(q);
        pyqTableBody.innerHTML = "";
        if(snapshot.empty){ pyqTableBody.innerHTML = "<tr><td colspan='3' class='text-center p-4'>No questions found</td></tr>"; return; }
        const items=[];
        snapshot.forEach(docSnap => items.push({ id: docSnap.id, ...docSnap.data() }));
        items.sort((a,b)=> (a.qno ?? Infinity) - (b.qno ?? Infinity));
        items.forEach(item=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="text-center font-medium align-top">${item.qno ?? '-'}</td>
            <td class="text-left align-top">${item.img ? `<img data-src="${item.img}" class="pyq-img" alt="Q ${item.qno ?? ''}">` : '-'}</td>
            <td class="text-center align-top">${item.sol ? `<img src="${item.sol}" class="pyq-img" alt="Sol ${item.qno ?? ''}" onclick="openImageModal('${item.sol}')">` : '-'}</td>
          `;
          pyqTableBody.appendChild(tr);
        });

        // watermark question images (those with data-src)
        const allImgs = pyqTableBody.querySelectorAll('.pyq-img');
        for(const img of allImgs){
          const src = img.getAttribute('data-src');
          if(!src) continue;
          try{
            const wm = await addWatermarkToImage(src,'AAHES');
            img.src = wm;
            img.addEventListener('click', ()=>openImageModal(wm));
          }catch(e){
            console.warn('Watermark failed', e);
            img.src = src;
            img.addEventListener('click', ()=>openImageModal(src));
          }
        }
      }catch(err){
        console.error(err);
        pyqTableBody.innerHTML = "<tr><td colspan='3' class='text-center p-4'>Failed to load questions</td></tr>";
      }
    }

    // ---------- Watermark helper ----------
    async function addWatermarkToImage(imgUrl, watermarkText='AAHES'){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = ()=>{
          try{
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.naturalWidth || img.width;
            canvas.height = img.naturalHeight || img.height;
            const MAX_DIM = 2400;
            let scale = 1;
            if(canvas.width > MAX_DIM || canvas.height > MAX_DIM){
              scale = Math.min(MAX_DIM / canvas.width, MAX_DIM / canvas.height);
              canvas.width = Math.floor(canvas.width * scale);
              canvas.height = Math.floor(canvas.height * scale);
            }
            ctx.drawImage(img,0,0,canvas.width,canvas.height);
            const fontSize = Math.max(10, Math.floor(canvas.width/25));
            ctx.font = `bold ${fontSize}px Quicksand, sans-serif`;
            ctx.fillStyle = 'rgba(255,255,255,0.10)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.rotate(-Math.PI/6);
            const stepX = fontSize * 6;
            const stepY = fontSize * 4;
            const startX = -canvas.width;
            const endX = canvas.width * 2;
            const startY = -canvas.height;
            const endY = canvas.height * 2;
            for(let x = startX; x < endX; x += stepX){
              for(let y = startY; y < endY; y += stepY){
                ctx.fillText(watermarkText, x - canvas.width/2, y - canvas.height/2);
              }
            }
            ctx.restore();
            resolve(canvas.toDataURL('image/png'));
          }catch(e){ reject(e); }
        };
        img.onerror = (e)=> reject(new Error('Image load failed'));
        img.src = imgUrl;
      });
    }

    // ---------- Image modal handlers ----------
    window.openImageModal = function(imgUrl){
      if(!imgUrl){ alert('No image'); return; }
      pyqImage.src = imgUrl;
      imageModal.classList.add('show');
      imageModal.setAttribute('aria-hidden','false');
    };
    imageModalClose.addEventListener('click', ()=>{ imageModal.classList.remove('show'); imageModal.setAttribute('aria-hidden','true'); pyqImage.src=''; });
    imageModal.addEventListener('click', (e)=>{ if(e.target === imageModal){ imageModal.classList.remove('show'); imageModal.setAttribute('aria-hidden','true'); pyqImage.src=''; }});
    pyqImage.addEventListener('click', e=> e.stopPropagation());

    // ---------- Profile modal ----------
    profileBtn?.addEventListener('click', ()=> {
      profileName.value = currentUser?.name || '';
      profileClass.value = currentUser?.class || '';
      profileModal.classList.add('show');
      profileModal.setAttribute('aria-hidden','false');
    });
    closeProfileModal.addEventListener('click', ()=>{ profileModal.classList.remove('show'); profileModal.setAttribute('aria-hidden','true'); });

    profileForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUser?.id){ alert('Not logged in'); return; }
      const updates = {};
      if(profileName.value.trim()) updates.name = profileName.value.trim();
      if(profileClass.value.trim()) updates.class = profileClass.value.trim();
      if(newPassword.value.trim()) updates.password = newPassword.value.trim();
      try{
        const userRef = doc(db, 'users', currentUser.id);
        await updateDoc(userRef, updates);
        currentUser = {...currentUser, ...updates};
        alert('Profile updated âœ…');
        profileModal.classList.remove('show');
      }catch(err){ console.error('Profile update', err); alert('Failed to update'); }
    });

    // ---------- Logout button ----------
    document.getElementById('logoutBtn').addEventListener('click', ()=>{
      currentUser = null;
      showAuth();
    });

    // ---------- Mobile sidebar overlay (kept minimal) ----------
    function enableOverlay(){ sidebar.classList.add('overlay'); }
    function openSidebar(){ enableOverlay(); sidebar.classList.add('open'); sidebarBackdrop.classList.add('show'); document.body.style.overflow='hidden'; }
    function closeSidebar(){ sidebar.classList.remove('open'); sidebarBackdrop.classList.remove('show'); setTimeout(()=>document.body.style.overflow='',300); }
    sidebarBackdrop.addEventListener('click', closeSidebar);
    window.addEventListener('resize', ()=>{ if(window.innerWidth <= 900) enableOverlay(); else { sidebar.classList.remove('overlay','open'); sidebarBackdrop.classList.remove('show'); document.body.style.overflow=''; } });

    // close auth overlay on ESC
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ if(imageModal.classList.contains('show')){ imageModal.classList.remove('show'); } else if(profileModal.classList.contains('show')){ profileModal.classList.remove('show'); } } });

    // init lucide icons if loaded
    if(window.lucide) window.lucide.createIcons();
  </script>
</body>
</html>
