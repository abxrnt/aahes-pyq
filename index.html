<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AAHES PYQ Portal</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="favicon.png">

  <!-- Quicksand font -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* -------------------------
       Base
       ------------------------- */
    :root {
      --sidebar-w: 260px;
    }
    html, body {
      margin: 0;
      height: 100%;
      font-family: 'Quicksand', sans-serif;
      background: #ffffff;
    }

    /* ---------- LOGIN (left/right) ---------- */
    .login-bg {
      display: flex;
      height: 100vh;
      width: 100%;
      background: linear-gradient(135deg, #1f2a44, #117a65);
    }
    .login-left {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 5rem 3rem;
      color: #f0f0f0;
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,0.25);
      animation: fadeSlide 0.8s ease forwards;
      border-radius: 0 2rem 2rem 0;
    }
    .login-left h1 { font-size: 2rem; margin-bottom: 1.5rem; }
    .login-left input {
      width: 100%;
      padding: 0.9rem;
      margin-bottom: 1.2rem;
      border-radius: 1rem;
      border: none;
      background: rgba(255,255,255,0.1);
      color: #f0f0f0;
      font-size: .95rem;
      outline: none;
      transition: all .25s;
    }
    .login-left input:focus { background: rgba(255,255,255,0.18); box-shadow: 0 0 12px rgba(255,255,255,0.18); }
    .login-left button {
      width: 100%;
      padding: .9rem;
      border-radius: 1rem;
      border: none;
      background: #14b8a6;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transition: all .2s;
    }
    .login-left button:hover { transform: translateY(-3px) scale(1.02); background: #0d9488; }

    .login-right {
      flex: 1;
      background: url('https://images.unsplash.com/photo-1688494930045-328d0f95efe9?fm=jpg&q=60&w=3000') center/cover no-repeat;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: white;
      position: relative;
      padding: 3rem;
      border-radius: 2rem 0 0 2rem;
      overflow: hidden;
    }
    .login-right::before {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.35);
      border-radius: 2rem 0 0 2rem;
      z-index: 0;
    }
    .login-right > div { position: relative; z-index: 1; animation: fadeInUp 1s ease forwards; }
    #logoimg { width: 110px; margin-bottom: 1rem; filter: drop-shadow(0 0 12px rgba(255,255,255,0.4)); }
    .login-right h2 { font-size: 2.6rem; font-weight: 600; margin-bottom: 1rem; text-shadow: 0 3px 10px rgba(0,0,0,0.6); }
    .login-right p { font-size: 1.05rem; line-height: 1.6; opacity: .95; text-shadow: 0 2px 6px rgba(0,0,0,0.5); }

    @keyframes fadeSlide { 0%{opacity:0;transform:translateX(-40px)}100%{opacity:1;transform:translateX(0)} }
    @keyframes fadeInUp  { 0%{opacity:0;transform:translateY(30px)}100%{opacity:1;transform:translateY(0)} }

    /* ---------- MAIN APP ---------- */
    #mainApp { display: none; height: 100vh; width: 100%; flex-direction: row; overflow: hidden; }

    /* Sidebar */
    #sidebar {
      width: var(--sidebar-w);
      min-width: var(--sidebar-w);
      background: #1f2937;
      padding: 1.5rem 1rem;
      color: white;
      height: 100vh;
      display:flex;
      flex-direction: column;
      justify-content: space-between;
      gap: .5rem;
    }
    #sidebar .logo-block { text-align:center; margin-bottom: .5rem; }
    #sidebar .logo-block img { width: 64px; margin: 0 auto .35rem; }
    #sidebar p#welcomeMsg { font-size: .95rem; margin-top: .3rem; color: #facc15; text-align:center; }

    #sidebar h3 { margin-bottom: .25rem; font-size: .85rem; color: #cbd5e1; }
    #sidebar button { padding: .4rem .6rem; border-radius: .5rem; font-weight:500; font-size:.85rem; color: white; border:none; display:flex; gap:.5rem; align-items:center; cursor:pointer; transition:all .2s; }
    #sidebar button:hover { transform: translateX(3px); }

    .profile-btn { background: #070e6b; color: #e6eef5; padding:.45rem .85rem; border-radius:.7rem; box-shadow: 0 4px 8px rgba(0,0,0,0.18); }
    .profile-btn:hover { background:#166cb3; transform: translateY(-2px); }
    .logout-btn { background:#f43f5e; padding:.45rem .85rem; border-radius:.7rem; }
    .logout-btn:hover { background:#e11d48; transform: translateY(-2px); }

    .tab-active { background: linear-gradient(135deg,#2563eb,#1e40af); color:#f8fafc; font-weight:600; box-shadow:0 6px 18px rgba(30,64,175,0.15); transform: translateY(-2px); }

    /* ---------- MAIN CONTENT ---------- */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
      background: #ffffff;
      min-height: 100vh;
    }

    /* Table */
    .table-wrap { overflow-x:auto; margin-bottom: 0; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; font-size: .95rem; }
    thead th { background: #0c2b4e; color: white; padding: .6rem .75rem; text-align:left; vertical-align: middle; }
    tbody td { padding: .6rem .75rem; vertical-align: top; }
    tbody tr:not(:last-child) { border-bottom: 2px solid #e5e7eb; } /* separator between rows */
    tbody tr:hover { background: #ffffff; transition: background .18s; }
    .pyq-img { max-width: 350px; height: auto; border-radius: .6rem; cursor:pointer; display:block; margin: 0 auto; }

    /* Modal */
    .modal { display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:50; }
    .modal.show { display:flex; }
    .modal-content { background:white; padding:2rem; border-radius:1.2rem; max-width:900px; width:92%; max-height:90vh; overflow:auto; position:relative; box-shadow:0 15px 30px rgba(0,0,0,0.35); }
    .close-btn { position:absolute; top:1rem; right:1rem; font-size:1.3rem; font-weight:bold; cursor:pointer; transition:all .15s; }
    .close-btn:hover { color:#f39c12; transform:scale(1.1); }

    /* Profile modal smaller form */
    #profileCard { max-width:500px; width:100%; }

    /* fine tuning header/top gap fix */
    .main-content .table-wrap { margin-top: 0; }
    .main-content thead th { padding-top: .4rem !important; }

    /* Responsive */
    @media (max-width: 900px) {
      #sidebar { display:none; }
      #mainApp { padding: 0; }
      .pyq-img { max-width: 220px; }
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div class="login-bg" id="loginSection">
    <div class="login-left">
      <h1>Welcome Back</h1>
      <input type="email" placeholder="Email" id="emailInput" autocomplete="username" />
      <input type="password" placeholder="Password" id="passInput" autocomplete="current-password" />
      <button id="loginBtn">Login</button>
      <p class="mt-2">Forgot your password? <a href="#" class="text-yellow-400 underline">Click here</a></p>
    </div>

    <div class="login-right">
      <div>
        <img id="logoimg" src="favicon.png" alt="AAHES logo" />
        <h2>AAHES PYQ Portal</h2>
        <p>Access previous year questions as images easily.<br>Prepare smarter and faster for your exams.</p>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <section id="mainApp" class="flex h-screen">
    <!-- SIDEBAR -->
    <div id="sidebar">
      <div>
        <div class="logo-block">
          <img src="favicon.png" alt="Logo">
          <div class="font-semibold text-lg">AAHES PYQ</div>
          <p id="welcomeMsg" class="mt-2 text-sm text-yellow-400 font-medium">Welcome, User! üòä</p>
          <p>Best of Luck!</p>
        </div>

        <div id="sidebarTop" class="mb-4 text-center">
          <div class="flex justify-center gap-2">
            <button id="profileBtn" class="profile-btn"><i data-lucide="user"></i> Profile</button>
            <button id="logoutBtn" class="logout-btn"><i data-lucide="log-out"></i> Logout</button>
          </div>
        </div>

        <div class="mb-3">
          <h3>Subjects</h3>
          <div id="subjectButtons" class="flex flex-col gap-2"></div>
        </div>

        <div class="mb-3">
          <h3>Years</h3>
          <div id="yearButtons" class="grid grid-cols-2 gap-2"></div>
        </div>
      </div>

      <div class="text-center">
        <small class="text-gray-400">AAHES ‚Ä¢ PYQ Portal</small>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
      <div class="table-wrap mb-4 -mt-2">
        <table>
          <thead>
            <tr>
              <th style="width:8%">QNo</th>
              <th style="width:46%">Question</th>
              <th style="width:46%">Solution</th>
            </tr>
          </thead>
          <tbody id="pyqTableBody">
            <tr>
              <td colspan="3" class="text-center p-4">Select a subject and year</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Extra area for notes -->
      <div class="mt-4 text-gray-600">
        <!-- placeholder -->
      </div>
    </div>
  </section>

  <!-- IMAGE MODAL -->
  <div id="imageModal" class="modal" aria-hidden="true">
    <div class="modal-content relative text-center" id="imageModalContent">
      <span class="close-btn" id="imageModalClose">&times;</span>
      <img id="pyqImage" src="" alt="Question preview" style="max-width:100%; height:auto; border-radius:.6rem;">
    </div>
  </div>

  <!-- PROFILE MODAL -->
  <div id="profileModal" class="modal" aria-hidden="true">
    <div class="modal-content" id="profileCard">
      <button id="closeProfileModal" class="close-btn">&times;</button>
      <h2 class="text-2xl font-semibold text-center mb-4">üë§ Profile Settings</h2>

      <form id="profileForm" class="space-y-4">
        <div>
          <label class="block font-medium mb-1">Full Name</label>
          <input id="profileName" type="text" class="w-full border px-3 py-2 rounded-lg outline-none" placeholder="Enter your name">
        </div>

        <div>
          <label class="block font-medium mb-1">Class</label>
          <input id="profileClass" type="text" class="w-full border px-3 py-2 rounded-lg outline-none" placeholder="Enter your class">
        </div>

        <div>
          <label class="block font-medium mb-1">Change Password</label>
          <div class="relative">
            <input id="newPassword" type="password" class="w-full border px-3 py-2 rounded-lg pr-10 outline-none" placeholder="New password">
            <button type="button" id="togglePassword" class="absolute right-3 top-2 text-gray-500">üëÅ</button>
          </div>
        </div>

        <button type="submit" id="saveProfileBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- JS (module) -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, updatePassword } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // ---------- FIREBASE CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBOVl1hdmprJXpgdN_sNTO3FsNePD_zNZY",
      authDomain: "aahes-cee-cutoffs.firebaseapp.com",
      databaseURL: "https://aahes-cee-cutoffs-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "aahes-cee-cutoffs",
      storageBucket: "aahes-cee-cutoffs.firebasestorage.app",
      messagingSenderId: "706066626405",
      appId: "1:706066626405:web:0d254ab82beb288108938c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ---------- DOM REFS ----------
    const loginBtn = document.getElementById("loginBtn");
    const loginSection = document.getElementById("loginSection");
    const mainApp = document.getElementById("mainApp");
    const pyqTableBody = document.getElementById("pyqTableBody");
    const subjectButtons = document.getElementById("subjectButtons");
    const yearButtons = document.getElementById("yearButtons");

    // profile refs
    const profileModal = document.getElementById("profileModal");
    const profileBtn = document.getElementById("profileBtn");
    const closeProfileModal = document.getElementById("closeProfileModal");
    const profileName = document.getElementById("profileName");
    const profileClass = document.getElementById("profileClass");
    const newPassword = document.getElementById("newPassword");
    const togglePassword = document.getElementById("togglePassword");
    const profileForm = document.getElementById("profileForm");

    // image modal refs
    const imageModal = document.getElementById("imageModal");
    const pyqImage = document.getElementById("pyqImage");
    const imageModalClose = document.getElementById("imageModalClose");

    // ---------- STATE ----------
    let currentUser = null;
    let currentSubject = "physics";
    let currentYear = 2025;
    const subjects = ["physics", "chemistry", "maths"];
    const years = [2025, 2024, 2023, 2022];

    // ---------- LOGIN ----------
    loginBtn.addEventListener("click", async () => {
      const email = document.getElementById("emailInput").value.trim();
      const password = document.getElementById("passInput").value.trim();
      if (!email || !password) { alert("Enter email & password"); return; }

      try {
        const q = query(collection(db, "users"), where("email", "==", email));
        const snapshot = await getDocs(q);
        if (snapshot.empty) { alert("User not found"); return; }

        let found = false;
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (data.password === password) {
            found = true;
            currentUser = { id: docSnap.id, ...data };
          }
        });

        if (!found) { alert("Incorrect password"); return; }
        onLoginSuccess();
      } catch (err) {
        console.error(err);
        alert("Login failed");
      }
    });

    function onLoginSuccess() {
      // hide login, show main app
      loginSection.style.display = "none";
      mainApp.style.display = "flex";
      document.getElementById("welcomeMsg").innerText = `Welcome, ${currentUser.name || 'User'}! üòä`;
      generateButtons();
      loadPYQs().catch(e => console.error(e));
      // render lucide icons
      if (window.lucide) window.lucide.createIcons();
    }

    // ---------- BUTTON GENERATION ----------
    function generateButtons() {
      // subjects
      subjectButtons.innerHTML = "";
      subjects.forEach(s => {
        const btn = document.createElement("button");
        btn.innerText = s.charAt(0).toUpperCase() + s.slice(1);
        if (s === currentSubject) btn.classList.add("tab-active");
        btn.addEventListener("click", () => {
          currentSubject = s;
          subjectButtons.querySelectorAll("button").forEach(b => b.classList.remove("tab-active"));
          btn.classList.add("tab-active");
          loadPYQs();
        });
        subjectButtons.appendChild(btn);
      });

      // years
      yearButtons.innerHTML = "";
      years.forEach(y => {
        const btn = document.createElement("button");
        btn.innerText = y;
        btn.classList.add("py-1", "rounded");
        if (y === currentYear) btn.classList.add("tab-active");
        btn.addEventListener("click", () => {
          currentYear = y;
          yearButtons.querySelectorAll("button").forEach(b => b.classList.remove("tab-active"));
          btn.classList.add("tab-active");
          loadPYQs();
        });
        yearButtons.appendChild(btn);
      });
    }

    // ---------- LOAD PYQS ----------
    async function loadPYQs() {
      try {
        pyqTableBody.innerHTML = "<tr><td colspan='3' class='text-center p-4'>Loading...</td></tr>";
        const q = query(collection(db, "pyqs"), where("subject", "==", currentSubject), where("year", "==", currentYear));
        const snapshot = await getDocs(q);
        pyqTableBody.innerHTML = "";

        if (snapshot.empty) {
          pyqTableBody.innerHTML = "<tr><td colspan='3' class='text-center p-4'>No questions found</td></tr>";
          return;
        }

        const items = [];
        snapshot.forEach(docSnap => {
          const d = docSnap.data();
          // include id optionally
          items.push({ id: docSnap.id, ...d });
        });

        // sort by qno if available
        items.sort((a, b) => (a.qno ?? Infinity) - (b.qno ?? Infinity));

        // render rows
        items.forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="text-center font-medium align-top">${item.qno ?? '-'}</td>
            <td class="text-center align-top">
              ${item.img ? `<img data-src="${item.img}" class="pyq-img" alt="Question ${item.qno ?? ''}">` : '-'}
            </td>
            <td class="text-center align-top">
              ${item.sol ? `<img src="${item.sol}" class="pyq-img" alt="Solution ${item.qno ?? ''}" onclick="openImageModal('${item.sol}')">` : '-'}
            </td>
          `;
          pyqTableBody.appendChild(tr);
        });

        // watermark question images
        const allImgs = pyqTableBody.querySelectorAll(".pyq-img");
        for (const img of allImgs) {
          // we only watermark images that came from data-src (questions)
          const src = img.getAttribute("data-src");
          if (!src) continue; // skip solution preview images (they already have src)
          try {
            const watermarked = await addWatermarkToImage(src, "AAHES");
            img.src = watermarked;
            // clicking should open modal with watermarked version
            img.addEventListener("click", () => openImageModal(watermarked));
          } catch (err) {
            console.warn("Watermark failed, using original src", err);
            img.src = src; // fallback
            img.addEventListener("click", () => openImageModal(src));
          }
        }

        // refresh icons
        if (window.lucide) window.lucide.createIcons();
      } catch (err) {
        console.error(err);
        pyqTableBody.innerHTML = "<tr><td colspan='3' class='text-center p-4'>Failed to load questions</td></tr>";
      }
    }

    // ---------- WATERMARK FUNCTION ----------
    // Repeats watermarkText diagonally across image, small and subtle
    async function addWatermarkToImage(imgUrl, watermarkText = "AAHES") {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous"; // try to allow cross origin
        img.onload = () => {
          try {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            // set canvas size to natural image size
            canvas.width = img.naturalWidth || img.width;
            canvas.height = img.naturalHeight || img.height;

            // limit extremely large images to avoid huge canvases
            const MAX_DIM = 2400;
            let scale = 1;
            if (canvas.width > MAX_DIM || canvas.height > MAX_DIM) {
              scale = Math.min(MAX_DIM / canvas.width, MAX_DIM / canvas.height);
              canvas.width = Math.floor(canvas.width * scale);
              canvas.height = Math.floor(canvas.height * scale);
            }

            // draw the image scaled
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            // watermark styling
            // responsive font size
            const fontSize = Math.max(10, Math.floor(canvas.width / 25));
            ctx.font = `bold ${fontSize}px Quicksand, sans-serif`;
            // white semi transparent, suits dark images. uses subtle alpha
            ctx.fillStyle = "rgba(255,255,255,0.10)";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            // rotate canvas context and fill repeated text in a grid
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(-Math.PI / 6); // -30 degrees

            // spacing steps (relative to font size)
            const stepX = fontSize * 6;
            const stepY = fontSize * 4;

            // start positions large enough to cover the canvas when rotated
            const startX = -canvas.width;
            const endX = canvas.width * 2;
            const startY = -canvas.height;
            const endY = canvas.height * 2;

            for (let x = startX; x < endX; x += stepX) {
              for (let y = startY; y < endY; y += stepY) {
                ctx.fillText(watermarkText, x - canvas.width / 2, y - canvas.height / 2);
              }
            }

            ctx.restore();

            // final image
            const dataUrl = canvas.toDataURL("image/png");
            resolve(dataUrl);
          } catch (err) {
            reject(err);
          }
        };
        img.onerror = (e) => {
          reject(new Error("Image load failed: " + e?.message));
        };
        img.src = imgUrl;
      });
    }

    // ---------- IMAGE MODAL HANDLERS ----------
    // global function used in some inline handlers
    window.openImageModal = function (imgUrl) {
      if (!imgUrl) { alert("No image available."); return; }
      pyqImage.src = imgUrl;
      imageModal.classList.add("show");
      imageModal.setAttribute("aria-hidden", "false");
    };

    imageModalClose.addEventListener("click", () => {
      imageModal.classList.remove("show");
      imageModal.setAttribute("aria-hidden", "true");
      pyqImage.src = "";
    });
    imageModal.addEventListener("click", (e) => {
      if (e.target === imageModal) {
        imageModal.classList.remove("show");
        imageModal.setAttribute("aria-hidden", "true");
        pyqImage.src = "";
      }
    });
    pyqImage.addEventListener("click", (e) => e.stopPropagation());

    // ---------- LOGOUT ----------
    document.getElementById("logoutBtn").addEventListener("click", () => {
      currentUser = null;
      loginSection.style.display = "flex";
      mainApp.style.display = "none";
    });

    // ---------- PROFILE MODAL OPEN/CLOSE ----------
    profileBtn.addEventListener("click", () => {
      // prefill current values
      profileName.value = currentUser?.name || "";
      profileClass.value = currentUser?.class || "";
      newPassword.value = "";
      profileModal.classList.add("show");
      profileModal.setAttribute("aria-hidden", "false");
    });

    closeProfileModal.addEventListener("click", () => {
      profileModal.classList.remove("show");
      profileModal.setAttribute("aria-hidden", "true");
    });

    profileModal.addEventListener("click", (e) => {
      if (e.target === profileModal) {
        profileModal.classList.remove("show");
        profileModal.setAttribute("aria-hidden", "true");
      }
    });

    // password toggle
    togglePassword.addEventListener("click", () => {
      newPassword.type = newPassword.type === "password" ? "text" : "password";
      togglePassword.innerText = newPassword.type === "password" ? "üëÅ" : "üôà";
    });

    // ---------- SAVE PROFILE CHANGES ----------
    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = profileName.value.trim();
      const className = profileClass.value.trim();
      const password = newPassword.value.trim();

      if (!currentUser?.id) {
        alert("User not logged in.");
        return;
      }

      try {
        const userRef = doc(db, "users", currentUser.id);
        const updates = {};
        if (name) updates.name = name;
        if (className) updates.class = className;
        if (password) updates.password = password;

        // update Firestore
        await updateDoc(userRef, updates);
        // update local copy
        currentUser = { ...currentUser, ...updates };

        // if firebase auth currentUser exists, try update auth password
        if (password && auth.currentUser) {
          try {
            await updatePassword(auth.currentUser, password);
          } catch (authErr) {
            console.warn("Password not updated in Auth (requires recent sign-in or email/password provider).", authErr);
            // it's safe to continue ‚Äî Firestore was updated
          }
        }

        alert("Profile updated successfully ‚úÖ");
        document.getElementById("welcomeMsg").innerText = `Welcome, ${currentUser.name || 'User'}! üòä`;
        profileModal.classList.remove("show");
        profileModal.setAttribute("aria-hidden", "true");
      } catch (err) {
        console.error("Profile update failed:", err);
        alert("Error updating profile. Check console for details.");
      }
    });

    // --------- Init lucide icons if available on first load ----------
    if (window.lucide) window.lucide.createIcons();
  </script>
</body>
</html>
