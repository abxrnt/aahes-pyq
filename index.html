<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AAHES PYQ Portal — Premium</title>

  <!-- Tailwind CDN (play) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { theme: { extend: { colors: { primary: '#0ea5a4', accent: '#7c3aed', surface: '#0b1220', muted: '#94a3b8' }, fontFamily: { inter: ['Inter', 'ui-sans-serif', 'system-ui'] } } } }</script>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* Small base polish on top of Tailwind so we can craft microinteractions */
    :root{ --glass: rgba(255,255,255,0.04); --glass-2: rgba(255,255,255,0.02); }
    html,body,#app{height:100%;}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,0.08), transparent), linear-gradient(180deg,#020617 0%, #071124 100%); color:#e6eef5}

    /* premium header */
    .logo-badge{display:flex;align-items:center;gap:.6rem}
    .logo-mark{width:48px;height:48px;border-radius:12px;display:inline-grid;place-items:center;background:linear-gradient(135deg,var(--tw-gradient-stops));}

    /* card glass */
    .glass { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); backdrop-filter: blur(8px); }

    /* subtle neon underline for active */
    .nav-btn.active{ box-shadow: 0 8px 30px rgba(99,102,241,0.09); border-left: 3px solid rgba(124,58,237,0.95); }

    /* hover micro-lift */
    .hover-lift{ transition: transform .18s cubic-bezier(.2,.9,.2,1), box-shadow .18s; }
    .hover-lift:hover{ transform: translateY(-6px); box-shadow: 0 18px 50px rgba(2,6,23,0.6); }

    /* image preview */
    .pyq-img{ max-width:420px; border-radius:10px; cursor:pointer; transition: transform .18s ease; }
    .pyq-img:hover{ transform: scale(1.02); }

    /* modal */
    .modal-backdrop{ background: linear-gradient(180deg, rgba(2,6,23,0.85), rgba(2,6,23,0.95)); }

    /* table style */
    table thead th{ color:#cbd5e1; font-weight:600; font-size:.95rem; }
    table tbody td{ color:#e6eef5; }

    /* responsive tweaks */
    @media (max-width: 900px){ .desktop-only{ display:none } }
  </style>
</head>
<body>
  <div id="app" class="flex h-screen">

    <!-- SIDEBAR -->
    <aside class="w-80 p-6 glass shadow-xl hidden md:flex flex-col justify-between">
      <div>
        <div class="logo-badge mb-6">
          <div class="logo-mark bg-gradient-to-br from-indigo-600 to-teal-400 text-white shadow-sm"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 12h18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 3v18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
          <div>
            <div class="text-lg font-semibold">AAHES PYQ</div>
            <div class="text-sm text-muted">Premium Student Portal</div>
          </div>
        </div>

        <div class="mb-5">
          <div class="text-xs text-muted uppercase tracking-wide mb-2">Account</div>
          <div class="flex items-center gap-3">
            <img src="favicon.png" alt="avatar" class="w-12 h-12 rounded-lg ring-1 ring-indigo-700/30"/>
            <div>
              <div id="nameDisplay" class="font-semibold">Welcome, User</div>
              <div class="text-xs text-muted">Class — <span id="classDisplay">12</span></div>
            </div>
          </div>
        </div>

        <nav class="space-y-2">
          <button id="navHome" class="nav-btn flex items-center gap-3 w-full rounded-md px-3 py-2 text-sm hover:bg-white/2 hover:text-white transition text-muted"> <i data-lucide="home" class="w-4 h-4"></i> Dashboard</button>
          <div class="mt-3 text-xs text-muted uppercase tracking-wide">Subjects</div>
          <div id="subjectButtons" class="mt-2 flex flex-col gap-2"></div>

          <div class="mt-4 text-xs text-muted uppercase tracking-wide">Years</div>
          <div id="yearButtons" class="mt-2 grid grid-cols-2 gap-2"></div>
        </nav>
      </div>

      <div class="text-sm text-muted">
        <div class="mb-3">AAHES • PYQ Portal</div>
        <div class="flex gap-2">
          <button id="profileBtn" class="w-full py-2 rounded-md bg-indigo-700/30 hover:bg-indigo-600/40 hover-lift">Profile</button>
          <button id="logoutBtn" class="w-full py-2 rounded-md bg-rose-600/20 hover:bg-rose-600/30">Logout</button>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="flex-1 p-6 overflow-auto">

      <!-- topbar -->
      <header class="flex items-center justify-between gap-4 mb-6">
        <div class="flex items-center gap-4">
          <button id="menuToggle" class="md:hidden p-2 rounded-md bg-white/3"><i data-lucide="menu"></i></button>
          <h1 class="text-2xl font-bold">AAHES PYQ</h1>
          <p class="text-muted hidden sm:inline">Dark Premium Dash — organized questions & solutions</p>
        </div>

        <div class="flex items-center gap-3">
          <div class="relative">
            <input id="searchBox" placeholder="Search question or QNo..." class="bg-white/3 rounded-full py-2 px-4 w-72 outline-none text-sm"/>
            <i data-lucide="search" class="absolute right-3 top-2 w-4 h-4 text-muted"></i>
          </div>
          <button id="uploadBtn" class="px-4 py-2 rounded-md bg-gradient-to-br from-teal-500 to-indigo-600 hover:scale-[1.02] transition shadow-md">Upload</button>
        </div>
      </header>

      <!-- content grid -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- left: controls + quick stats -->
        <div class="col-span-1 glass p-5 rounded-2xl shadow-lg">
          <div class="flex items-center justify-between mb-4">
            <div>
              <div class="text-xs text-muted uppercase">Selected</div>
              <div id="selectedSubject" class="font-semibold text-lg">Physics • 2025</div>
            </div>
            <div class="text-right">
              <div class="text-sm text-muted">Questions</div>
              <div id="qcount" class="font-semibold text-lg">0</div>
            </div>
          </div>

          <div class="mt-4 space-y-3">
            <div>
              <label class="text-xs text-muted">Filter by topic (optional)</label>
              <input id="filterTopic" class="w-full mt-2 p-2 rounded-md bg-white/3 text-sm" placeholder="e.g., Mechanics" />
            </div>
            <div>
              <label class="text-xs text-muted">Sort</label>
              <select id="sortSelect" class="w-full mt-2 p-2 rounded-md bg-white/3 text-sm">
                <option value="qno">By QNo</option>
                <option value="recent">Most recent</option>
              </select>
            </div>
            <button id="refreshBtn" class="w-full py-2 rounded-md bg-indigo-600 hover:brightness-105 transition hover-lift">Refresh</button>
          </div>
        </div>

        <!-- center: table list -->
        <div class="col-span-2 lg:col-span-2">
          <div class="glass p-4 rounded-2xl shadow-lg">
            <div class="overflow-x-auto">
              <table class="w-full table-auto">
                <thead>
                  <tr>
                    <th class="text-left p-3">QNo</th>
                    <th class="text-left p-3">Question</th>
                    <th class="text-left p-3">Solution</th>
                  </tr>
                </thead>
                <tbody id="pyqTableBody">
                  <tr><td colspan="3" class="text-center py-8 text-muted">Select a subject & year to load questions</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- right: previews & notes -->
        <aside class="col-span-1 glass p-5 rounded-2xl shadow-lg">
          <div class="mb-4">
            <div class="text-xs text-muted mb-2">Preview</div>
            <div class="h-44 bg-white/2 rounded-lg flex items-center justify-center border border-white/4">
              <img id="previewImg" src="" class="max-h-40 max-w-full rounded-md" alt="preview" />
              <div id="previewEmpty" class="text-muted">No image selected</div>
            </div>
          </div>

          <div>
            <div class="text-xs text-muted mb-2">Notes</div>
            <textarea id="notes" rows="6" class="w-full p-3 rounded-md bg-white/3 text-sm placeholder:text-muted" placeholder="Add quick notes for this selection..."></textarea>
            <button id="saveNote" class="mt-3 w-full py-2 rounded-md bg-teal-500 hover:brightness-105">Save Note</button>
          </div>
        </aside>
      </section>

    </main>
  </div>

  <!-- image modal -->
  <div id="imageModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
    <div class="max-w-4xl w-full p-6 rounded-2xl glass">
      <div class="flex justify-end"><button id="closeModal" class="p-2 rounded-md">&times;</button></div>
      <div class="flex items-center justify-center"><img id="modalImg" src="" class="max-h-[70vh] max-w-full rounded-lg" /></div>
    </div>
  </div>

  <!-- profile modal -->
  <div id="profileModal" class="fixed inset-0 z-40 hidden items-center justify-center modal-backdrop">
    <div class="w-full max-w-md p-6 rounded-2xl glass">
      <div class="flex justify-between items-center mb-3">
        <div class="text-lg font-semibold">Profile</div>
        <button id="closeProfile" class="p-2 rounded-md">&times;</button>
      </div>
      <form id="profileForm" class="space-y-3">
        <input id="profileName" class="w-full p-3 rounded-md bg-white/3" placeholder="Full name" />
        <input id="profileClass" class="w-full p-3 rounded-md bg-white/3" placeholder="Class" />
        <input id="newPassword" type="password" class="w-full p-3 rounded-md bg-white/3" placeholder="New password (optional)" />
        <div class="flex gap-2">
          <button type="submit" class="flex-1 py-2 rounded-md bg-indigo-600">Save</button>
          <button type="button" id="cancelProfile" class="flex-1 py-2 rounded-md bg-white/5">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    // Firebase imports (same as original) but kept modular for your environment
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOVl1hdmprJXpgdN_sNTO3FsNePD_zNZY",
      authDomain: "aahes-cee-cutoffs.firebaseapp.com",
      databaseURL: "https://aahes-cee-cutoffs-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "aahes-cee-cutoffs",
      storageBucket: "aahes-cee-cutoffs.firebasedatabase.app",
      messagingSenderId: "706066626405",
      appId: "1:706066626405:web:0d254ab82beb288108938c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // STATE
    let currentUser = null;
    let currentSubject = 'physics';
    let currentYear = 2025;
    const subjects = ['physics','chemistry','maths'];
    const years = [2025,2024,2023,2022];

    // DOM refs
    const subjectButtons = document.getElementById('subjectButtons');
    const yearButtons = document.getElementById('yearButtons');
    const pyqTableBody = document.getElementById('pyqTableBody');
    const selectedSubject = document.getElementById('selectedSubject');
    const qcount = document.getElementById('qcount');
    const previewImg = document.getElementById('previewImg');
    const previewEmpty = document.getElementById('previewEmpty');
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImg');
    const closeModal = document.getElementById('closeModal');

    // init UI
    generateButtons();
    renderWelcome();

    // generate subject/year buttons
    function generateButtons(){
      subjectButtons.innerHTML = '';
      subjects.forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'text-left py-2 px-3 rounded-md hover:bg-white/2 hover-lift text-sm';
        btn.innerText = s[0].toUpperCase()+s.slice(1);
        if (s === currentSubject) btn.classList.add('active');
        btn.addEventListener('click', () => { currentSubject = s; subjectButtons.querySelectorAll('button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); loadPYQs(); updateSelected(); });
        subjectButtons.appendChild(btn);
      });

      yearButtons.innerHTML = '';
      years.forEach(y => {
        const btn = document.createElement('button');
        btn.className = 'py-2 rounded-md hover:bg-white/2 text-sm';
        btn.innerText = y;
        if (y === currentYear) btn.classList.add('active');
        btn.addEventListener('click', () => { currentYear = y; yearButtons.querySelectorAll('button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); loadPYQs(); updateSelected(); });
        yearButtons.appendChild(btn);
      });
    }

    function renderWelcome(){
      document.getElementById('nameDisplay').innerText = 'Welcome, Student';
      document.getElementById('classDisplay').innerText = '12';
      updateSelected();
    }

    function updateSelected(){
      selectedSubject.innerText = `${currentSubject[0].toUpperCase()+currentSubject.slice(1)} • ${currentYear}`;
    }

    // load PYQs (firestore)
    async function loadPYQs(){
      try{
        pyqTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-8">Loading...</td></tr>';
        const q = query(collection(db,'pyqs'), where('subject','==', currentSubject), where('year','==', currentYear));
        const snapshot = await getDocs(q);
        const items = [];
        snapshot.forEach(docSnap => items.push({ id: docSnap.id, ...docSnap.data() }));
        if (!items.length) { pyqTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-muted">No questions found</td></tr>'; qcount.innerText = '0'; return; }

        items.sort((a,b) => (a.qno ?? Infinity) - (b.qno ?? Infinity));
        qcount.innerText = items.length;
        pyqTableBody.innerHTML = '';

        items.forEach(item => {
          const tr = document.createElement('tr');
          tr.className = 'border-b border-white/6';
          tr.innerHTML = `
            <td class="p-3 align-top font-medium">${item.qno ?? '-'}</td>
            <td class="p-3 align-top">
              ${item.img ? `<img data-src="${item.img}" class="pyq-img" alt="Q${item.qno ?? ''}" />` : '-'}
            </td>
            <td class="p-3 align-top">${item.sol ? `<img src="${item.sol}" class="pyq-img" alt="Sol ${item.qno ?? ''}" onclick="openModal('${item.sol}')">` : '-'}</td>
          `;
          pyqTableBody.appendChild(tr);
        });

        // watermark question images only
        const allImgs = pyqTableBody.querySelectorAll('img[data-src]');
        for (const img of allImgs){
          const src = img.getAttribute('data-src');
          try{
            const watermarked = await addWatermarkToImage(src, 'AAHES');
            img.src = watermarked;
            img.addEventListener('click', () => openModal(watermarked));
          }catch(e){ img.src = src; img.addEventListener('click', () => openModal(src)); }
        }

      }catch(err){ console.error(err); pyqTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-8 text-rose-400">Failed to load questions</td></tr>'; }
    }

    // watermark: improved subtle diagonal pattern, safe with CORS fallback
    async function addWatermarkToImage(imgUrl, watermarkText='AAHES'){
      return new Promise((resolve,reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          try{
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;

            const MAX = 2000; let scale = 1;
            if (canvas.width>MAX || canvas.height>MAX){ scale = Math.min(MAX/canvas.width, MAX/canvas.height); canvas.width = Math.round(canvas.width*scale); canvas.height = Math.round(canvas.height*scale); }

            ctx.drawImage(img,0,0,canvas.width,canvas.height);

            const fontSize = Math.max(12, Math.floor(canvas.width/30));
            ctx.font = `600 ${fontSize}px Inter, sans-serif`;
            ctx.fillStyle = 'rgba(255,255,255,0.08)';
            ctx.textAlign = 'center'; ctx.textBaseline='middle';

            ctx.save(); ctx.translate(canvas.width/2, canvas.height/2); ctx.rotate(-Math.PI/6);
            const stepX = fontSize*6; const stepY = fontSize*5;
            for(let x=-canvas.width; x<canvas.width*2; x+=stepX){ for(let y=-canvas.height; y<canvas.height*2; y+=stepY){ ctx.fillText(watermarkText, x-canvas.width/2, y-canvas.height/2); }}
            ctx.restore();

            resolve(canvas.toDataURL('image/png'));
          }catch(e){ reject(e); }
        };
        img.onerror = (e) => reject(new Error('Image load failed'));
        img.src = imgUrl + (imgUrl.includes('?') ? '&' : '?') + 'cachebust=' + Date.now();
      });
    }

    // modal open/close
    window.openModal = function(src){ modal.classList.remove('hidden'); modal.classList.add('flex'); modalImg.src = src; previewImg.src = src; previewEmpty.style.display = 'none'; };
    closeModal.addEventListener('click', () => { modal.classList.add('hidden'); modal.classList.remove('flex'); modalImg.src = ''; });
    modal.addEventListener('click', (e)=>{ if (e.target === modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); modalImg.src=''; } });

    // small helpers
    document.getElementById('refreshBtn')?.addEventListener('click', loadPYQs);

    // init first load
    loadPYQs();

    // lucide icons
    if (window.lucide) window.lucide.createIcons();
  </script>
</body>
</html>
